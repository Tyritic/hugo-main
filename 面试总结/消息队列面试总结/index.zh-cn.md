---
date : '2025-03-24T10:10:30+08:00'
draft : false
title : '消息队列面试总结'
image : ""
categories : ["Kafka"]
tags : ["后端开发"]
description : "Kafka的常见面试题"
math : true
---

## Kafka的消息可靠性如何保障？

- **数据持久化与日志结构** ：Kafka 将所有消息以追加写入的方式记录到磁盘上的日志文件中，写入顺序保证了数据持久化，同时可以通过顺序写入提高 IO 性能。
- **副本机制** ：每个分区的消息会在多个 Broker 上备份（副本），当 Leader 宕机时，Follower 可以接替服务，从而保证数据不丢失。客户端可以设置 ACK 级别（例如 `acks=all`）来确保所有副本都确认写入后再返回成功。
- **数据同步与恢复** ：当某个节点出现故障时，Kafka 会自动从其他节点恢复数据，确保集群整体数据的高可用性。
- **事务机制与幂等性（Producer 端）** ：Kafka 还支持幂等性生产者和事务特性，通过为每个生产者分配唯一的 producerId 和维护序列号，实现生产端的 exactly-once 语义，防止消息重复写入。

### 消费者幂等性如何实现

在消费者侧，幂等性主要用于防止由于重复消费或重试导致业务数据被重复处理。实现消费者幂等性常见做法是 **去重** ，而去重的关键是为每条消息赋予一个全局唯一标识（唯一 ID）。

- **利用消息中的唯一 ID 进行去重** ：每条消息携带一个业务唯一 ID，消费者在处理消息时先检查该 ID 是否已经处理过（例如记录在数据库、缓存或专门的幂等性存储中），如果已处理则跳过，从而实现幂等消费。
- **使用 Kafka 内部位移（offset）配合外部存储** ：通过记录消费者的处理位移和业务数据标识，确保重复消费时能够判断该消息是否已经处理。

### 唯一ID的生成策略

通常在生产者侧生成唯一ID，在消息产生阶段，由业务生产者在构造消息时生成全局唯一的 ID（如 UUID、Snowflake 算法生成的 ID等）。

- 业务相关性： 唯一 ID 通常与业务上下文相关，可以更灵活地设计和使用。
- 及时性： 生产者在发送消息前就能确定消息标识，消费者无需额外计算或依赖外部数据。
- 跨系统一致性： 当多个系统写入同一主题时，统一由生产者生成的唯一 ID 能够更好地支持跨系统去重逻辑。
